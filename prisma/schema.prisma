generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id          String   @id @default(cuid())
  name        String
  email       String?  @unique
  password    String?
  isGuest     Boolean  @default(false)
  isBot       Boolean  @default(false)
  gamesPlayed Int      @default(0)
  gamesWon    Int      @default(0)
  createdAt   DateTime @default(now())

  hostedGames Game[]              @relation("GameHost")
  players     GamePlayer[]
  gameResults GameHistoryPlayer[]
}

model Game {
  id     String     @id @default(cuid())
  code   String     @unique
  host   User       @relation("GameHost", fields: [hostId], references: [id])
  hostId String
  status GameStatus @default(LOBBY)

  playerCount    Int     @default(4)
  twosHigh       Boolean @default(false)
  tradingEnabled Boolean @default(true)
  winScore       Int     @default(50)

  currentRound Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  gameState Json? // Stores the full game state for active games

  players GamePlayer[]
  rounds  Round[]
}

enum GameStatus {
  LOBBY
  TRADING
  PLAYING
  ROUND_END
  GAME_OVER
}

model GamePlayer {
  id     String @id @default(cuid())
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId String
  user   User   @relation(fields: [userId], references: [id])
  userId String

  seatPosition Int   @default(0)
  totalScore   Int   @default(0)
  currentRank  Rank?

  @@unique([gameId, userId])
  @@unique([gameId, seatPosition])
}

enum Rank {
  KING
  QUEEN
  NOBLE
  PEASANT
}

model Round {
  id          String   @id @default(cuid())
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId      String
  roundNumber Int

  finishOrder   String[]
  pointsAwarded Json

  createdAt DateTime @default(now())

  @@unique([gameId, roundNumber])
}

model GameHistory {
  id            String   @id @default(cuid())
  code          String   // Original game code for reference
  playerCount   Int
  twosHigh      Boolean
  tradingEnabled Boolean
  winScore      Int
  totalRounds   Int

  winnerId      String   // User ID of the winner
  winnerName    String   // Cached winner name
  winnerScore   Int

  completedAt   DateTime @default(now())

  players       GameHistoryPlayer[]
}

model GameHistoryPlayer {
  id            String      @id @default(cuid())
  gameHistory   GameHistory @relation(fields: [gameHistoryId], references: [id], onDelete: Cascade)
  gameHistoryId String
  user          User        @relation(fields: [userId], references: [id])
  userId        String

  playerName    String      // Cached name at time of game
  finalScore    Int
  finalPosition Int         // 1st, 2nd, 3rd, etc.
  isWinner      Boolean     @default(false)

  @@unique([gameHistoryId, userId])
}
