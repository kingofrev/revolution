generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String   @id @default(cuid())
  name        String
  email       String?  @unique
  password    String?
  isGuest     Boolean  @default(false)
  gamesPlayed Int      @default(0)
  gamesWon    Int      @default(0)
  createdAt   DateTime @default(now())

  hostedGames Game[]       @relation("GameHost")
  players     GamePlayer[]
}

model Game {
  id     String     @id @default(cuid())
  code   String     @unique
  host   User       @relation("GameHost", fields: [hostId], references: [id])
  hostId String
  status GameStatus @default(LOBBY)

  playerCount    Int     @default(4)
  twosHigh       Boolean @default(false)
  tradingEnabled Boolean @default(true)
  winScore       Int     @default(50)

  currentRound Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  players GamePlayer[]
  rounds  Round[]
}

enum GameStatus {
  LOBBY
  TRADING
  PLAYING
  ROUND_END
  GAME_OVER
}

model GamePlayer {
  id     String @id @default(cuid())
  game   Game   @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId String
  user   User   @relation(fields: [userId], references: [id])
  userId String

  seatPosition Int   @default(0)
  totalScore   Int   @default(0)
  currentRank  Rank?

  @@unique([gameId, userId])
  @@unique([gameId, seatPosition])
}

enum Rank {
  KING
  QUEEN
  NOBLE
  PEASANT
}

model Round {
  id          String   @id @default(cuid())
  game        Game     @relation(fields: [gameId], references: [id], onDelete: Cascade)
  gameId      String
  roundNumber Int

  finishOrder   String[]
  pointsAwarded Json

  createdAt DateTime @default(now())

  @@unique([gameId, roundNumber])
}
